<!DOCTYPE HTML>
<html lang="zh">
<head class="add-md">
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>文章广场 - Leo's site</title>
    <link type="text/css" rel="stylesheet" href="../style.css">
    <script src="../js/jquery.min.js"></script>
    <script src="../js/jquery.cookie.min.js"></script>
    <script src="../js/base.min.js"></script>
    <link rel="icon" href="https://gitee.com/Leo-hele/leo-hele.github.io-images/raw/main/favicon.ico" type="image/x-icon"/>
</head>
<body>
<div id="header-container">
    <div id="header">
    <div class="header" style="position: relative;">
      
      <a href="/" class="headerItem" data-nas style="color: #f5f5f7;">
        首页
      </a>
      
      <a href="/about" class="headerItem" data-nas style="color: #f5f5f7;">
        关于
      </a>
      
      <a href="/blogs" class="headerItem" data-nas style="color: #f5f5f7;">
        文章
      </a>
      
    </div>

    <h1 class="toc-ignore">欢迎来到Leo的网站</h1>
    <noscript>
        <h2 class="toc-ignore">您的浏览器不支持JavaScript</h2>
        <p>请启用JavaScript以获得更好的体验</p>
    </noscript>
</div>
    <div class="div-fixid center-all" style="color: #ffff00;">
        <strong style="font-size: 40px;" id="bg-text">保持安静</strong>
    </div>
    <button id="back-to-top" class="back">↑</button>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const backToTopButton = document.getElementById("back-to-top");
        backToTopButton.style.display = "none";

        window.addEventListener("scroll", function () {
            if (window.scrollY > 0) {
                backToTopButton.style.display = "block";
            } else {
                backToTopButton.style.display = "none";
            }
        });

        backToTopButton.addEventListener("click", function () {
            window.scrollTo({top: 0, behavior: "smooth"});
        });
    });
</script>
<script>
    $(document).ready(function () {
        let direction = {
            left: false,
            top: false,
            right: false,
            bottom: false
        }; //上下左右

        setInterval(function () {
            if (direction.left) {
                window.scrollBy(-10, 0);
            } else if (direction.top) {
                window.scrollBy(0, -10);
            } else if (direction.right) {
                window.scrollBy(10, 0);
            } else if (direction.bottom) {
                window.scrollBy(0, 10);
            }
        }, 1);

        document.addEventListener("keydown", function (e) {
            switch (e.key) {
                case "ArrowLeft":
                    direction.left = true;
                    break;
                case "ArrowUp":
                    direction.top = true;
                    break;
                case "ArrowRight":
                    direction.right = true;
                    break;
                case "ArrowDown":
                    direction.bottom = true;
                    break;
            }
        });
        document.addEventListener("keyup", function (e) {
            switch (e.key) {
                case "ArrowLeft":
                    direction.left = false;
                    break;
                case "ArrowUp":
                    direction.top = false;
                    break;
                case "ArrowRight":
                    direction.right = false;
                    break;
                case "ArrowDown":
                    direction.bottom = false;
                    break;
            }
        });
    })
</script>
    <script>
        function changeBgText() {
            const bgText = document.getElementById("bg-text");
            if (bgText.style.display === "none") {
                bgText.style.display = "block";
            } else {
                bgText.style.display = "none";
            }
        }

        window.changeBgText = changeBgText;
    </script>
    <script src="../js/getDate.js"></script>
<footer>
    <button id='time-btn' style='position: fixed; bottom: 15px; right: 120px; border: groove;'>隐藏时间</button>
    <p id='time' style='position: fixed; bottom: 0; right: 0;'>
        当前时间:<br/>
        <span id="time-show"></span>
    </p>
    <script>
        function setTime() {
            document.getElementById("time-show").innerHTML = date().toString();
        }

        setTime();
        setInterval(setTime, 1000);

        function changeTime() {
            const timeParagraph = document.querySelector('p#time');
            const timeButton = document.getElementById('time-btn');
            if (timeParagraph.style.display === 'none') {
                timeParagraph.style.display = 'block';
                timeButton.textContent = '隐藏时间';
            } else {
                timeParagraph.style.display = 'none';
                timeButton.textContent = "显示时间";
                timeButton.style.display = 'none';
            }
        }

        document.getElementById('time-btn').addEventListener('click', function () {
            changeTime();
            if (this.style.display === 'none') {
                this.style.display = 'block';
            }
        });
    </script>
</footer>
    <script src="../js/translate.js"></script>
<script type="module">
    const loaded = await loadJson("../lang.json");
    const btot = loaded[0], ttob = loaded[1];
    translate.service.use('client.edge');
    const user_language = navigator.language;
    // console.log(user_language);
    translate.language.setDefaultTo(btot[user_language]);
    translate.language.setLocal(user_language);
    translate.listener.start();
    translate.selectLanguageTag.show = true;
    // document.getElementById("translateSelectLanguage").querySelectorAll("option").forEach(
    //     (item) => {
    //         console.log(item.value);
    //     }
    // )
</script>
</div>
<div id="body-content">
    <style>
    #search-input {
        width: 70%;
        margin-left: 20px;
        z-index: 1000;
        background-color: rgba(255, 255, 255, 0.95);
        border: groove #cccccc;
        border-radius: 25px;
        height: 50px;
        font-size: 25px;
        padding-left: 20px;
    }

    #search-class {
        margin-left: 20px;
        width: 90%;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        background-color: rgba(255, 255, 255, 0.95);
        border: groove #cccccc;
        border-radius: 25px;
        font-size: 25px;
        padding-left: 20px;
    }

    #search {
        display: none;
    }

    #search-button {
        width: 50px;
        height: 50px;
        background-color: transparent;
        border: none;
        cursor: pointer;
        padding-top: 10px;
        right: 0;
    }

    .class-select {
        color: black;
    }

    #search-class li::marker {
        display: none;
        content: "";
    }

    .blog-item {
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
        color: black;
    }

    #blog-container {
        position: fixed;
        right: 100%;
        top: 100px;
        bottom: 100%;
        overflow: auto;
        padding: 10px;
        background: #ffffff;
        color: #000000;
        border: groove #cccccc 3px;
        border-radius: 25px;
        z-index: 1000;
    }
</style>
<button id="showSearch-button">筛选器</button>
<div id="search">
    <div style="height: 50px;">
        <input id="search-input" type="text" placeholder="搜索文章..."/>
        <button onclick="updateSearch();" title="搜索" id="search-button">
            <img src="https://gitee.com/Leo-hele/leo-hele.github.io-images/raw/main/search.png" alt="搜索" title="搜索"
                 style="width: 50px; height: 50px;">
        </button>
        <input id="search-input-contents" type="checkbox" onclick="updateSearch();"/>
        <label for="search-input-contents">搜索内容</label>
    </div>
    <div id="search-class"></div>
</div>
<script type="module">
    import {pinyin} from "../js/pinyin-pro/dist/index.mjs";

    // 拼音转换函数
    function getPinyin(text, options = {}) {
        const defaultOptions = {
            toneType: 'none',
            pattern: 'pinyin',
            type: 'array',
            multiple: true,
            removeNonZh: false
        };

        try {
            const result = pinyin(text, { ...defaultOptions, ...options });
            return Array.isArray(result) ? result.join('\0') : result;
        } catch (error) {
            console.error('拼音转换出错:', error);
            return text;
        }
    }
    window.getPinyin = getPinyin;
</script>
<script>
    function getPinyinKey(str) {
        const title = getPinyin(str);
        let tmp = 0;
        const maxChar = 128;
        for (const i in title){
            tmp += title[i].charCodeAt(0) * Math.pow(maxChar, -i-1);
        }
        return tmp;
    }
    const time = new Date().getTime();
    function KeyName(blog) {
        return getPinyinKey(blog.title);
    }
    function KeyClass(blog) {
        return getPinyinKey(blog.class);
    }
    function KeyDate(blog) {
        const date = new Date(blog.date);
        return date.getTime() / time; // Normalize to a smaller range
    }
    function Jaccard(a, b) {
        const setA = new Set(a.split(/\s+/).map(word => word.toLowerCase()));
        const setB = new Set(b.split(/\s+/).map(word => word.toLowerCase()));
        const intersection = new Set([...setA].filter(x => setB.has(x)));
        const union = new Set([...setA, ...setB]);
        return intersection.size / union.size;
    }
    function Dice(a, b) {
        const setA = new Set(a.split(/\s+/).map(word => word.toLowerCase()));
        const setB = new Set(b.split(/\s+/).map(word => word.toLowerCase()));
        const intersection = new Set([...setA].filter(x => setB.has(x)));
        return (2 * intersection.size) / (setA.size + setB.size);
    }
    function Levenshtein(a, b) {
        const m = a.length;
        const n = b.length;
        console.log(n, m);
        const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
        console.log(dp);
        for (let i = 0; i <= m; i++) {
            dp[i][0] = i;
        }
        for (let j = 0; j <= n; j++) {
            dp[0][j] = j;
        }
        for (let i = 1; i <= m; i++) {
            for (let j = 1; j <= n; j++) {
                if (a[i - 1] === b[j - 1]) {
                    dp[i][j] = dp[i - 1][j - 1];
                } else {
                    dp[i][j] = Math.min(dp[i - 1][j], dp[i][j - 1], dp[i - 1][j - 1]) + 1;
                }
            }
        }
        return 1 - dp[m][n] / Math.max(m, n);
    }
    function Hamming(a, b) {
        let distance = 0;
        for (let i = 0; i < a.length; i++) {
            if (a[i] !== b[i]) {
                distance++;
            }
        }
        return 1 - distance / Math.max(a.length, b.length);
    }
    function CosineSimilarity(a, b) {
        const vectorA = a.split(/\s+/).map(word => word.toLowerCase());
        const vectorB = b.split(/\s+/).map(word => word.toLowerCase());
        const setA = new Set(vectorA);
        const setB = new Set(vectorB);
        const intersection = new Set([...setA].filter(x => setB.has(x)));
        return intersection.size / Math.sqrt(setA.size * setB.size);
    }
    function KeyCorrelation(Similarity) {
        return (blog) => {
            const searchInput = document.getElementById("search-input").value.toLowerCase();
            if (!searchInput) {
                return 0; // No search input, return 0 correlation
            }
            let title = blog.title.toLowerCase();
            if (document.getElementById("search-input-contents").checked) {
                title += loadFile(blog.url).toLowerCase();
            }
            return Similarity(title, searchInput);
        };
    }
    function KeyHot(blog) {
        return blog.hot;
    }
    function KeyAll(blog) {
        return KeyCorrelation(CosineSimilarity)(blog) * 27 + KeyHot(blog) * 4;
    }
    function CmpLess(a, b){return a - b;}
    function CmpGreater(a, b){return b - a;}
    let Keys = [KeyAll, KeyName, KeyClass, KeyDate, KeyHot];
    let KeyNames = ["智能排序（0×标题+0×分类+0×日期+27×相关性 Cosine+4×热度）", "标题", "分类", "日期", "热度"];
    let Cmps = [CmpGreater, CmpLess];
    let CmpNames = ["降序", "升序"];
    let SimilarityNames = ["Jaccard", "Dice", "Levenshtein", "Hamming", "Cosine"];
    let Similarities = [Jaccard, Dice, Levenshtein, Hamming, CosineSimilarity];

    for (let i in Similarities){
        Keys.push(KeyCorrelation(Similarities[i]));
        KeyNames.push("相关性 " + SimilarityNames[i]);
    }
</script>
<select id="cmp" onchange="updateSearch()">
</select>
<select id="key" onchange="updateSearch()">
</select>
<div id="search-container">
    <p>加载中...</p>
</div>
<div id="blog-container">
    <div id="blog-dec"></div>
    <iframe id="blog-frame"></iframe>
</div>
<script>
    window.title = $(document).attr('title');
</script>
<script>
    changeBgText();
    changeTime();
    const searchInput = $("#search-input");

    function getSearch() {
        const search = getParam("search");
        if (search) {
            searchInput.val(search);
        } else {
            const cookieSearch = getCookie("search");
            if (cookieSearch) {
                searchInput.val(cookieSearch);
            }
        }
        updateSearch();
    }

    function getSelectClass() {
        const selectClass = getParam("class");
        if (selectClass) {
            const classes = selectClass.split(',');
            classes.forEach((item) => {
                const checkbox = $("#search-class").find(`input[id="/所有分类${item}"]`);
                checkbox.click();
                checksClass.add(item);
            });
        } else {
            let cookieClass = getCookie("class");
            if (!cookieClass) {
                cookieClass = getClasses();
                setCookie("class", cookieClass);
            }
            cookieClass.forEach((item) => {
                const checkbox = $("#search-class").find(`input[id="/所有分类${item}"]`);
                checkbox.click();
                checksClass.add(item);
            });
        }
        updateSearch();
    }

    function InitSort() {
        const keySelect = $("#key");
        const cmpSelect = $("#cmp");

        // 清空现有选项
        keySelect.empty();
        cmpSelect.empty();

        // 添加键选项
        for (const key in Keys) {
            const option = $("<option>");
            option.val(key);
            option.text(KeyNames[key]);
            keySelect.append(option);
        }

        // 添加比较选项
        for (const cmp in Cmps) {
            const option = $("<option>");
            option.val(cmp);
            option.text(CmpNames[cmp]);
            cmpSelect.append(option);
        }
    }

    function ShowSearch() {
        const search = $("#search");
        const searchButton = $("#showSearch-button");
        if (search.css("display") === "none" || search.css("display") === "") {
            search.show();
            searchButton.html("隐藏筛选器");
        } else {
            search.hide();
            searchButton.html("筛选器");
        }
        execute();
    }

    $(document).ready(() => {
        $("#showSearch-button").on("click", ShowSearch);
    });

    function Check(checkbox) {
        const childrenCheckboxes = $(checkbox).children().eq(2).find('input');
        let checkedCount = 0;
        let uncheckedCount = 0;
        childrenCheckboxes.each((index, child) => {
            if ($(child).prop("checked")) {
                checkedCount++;
            } else {
                uncheckedCount++;
            }
        });
        if (uncheckedCount === 0) {
            return 1; // 全部未选中
        } else if (checkedCount === 0) {
            return 0; // 全部选中
        } else {
            return -1; // 部分选中
        }
    }

    let checksClass = new Set();
    window.checksClass = checksClass;
    const blogFrame = $("#blog-frame");
    const blogDec = $("#blog-dec");

    function loadSearch() {
        return loadJson("../search.json");
    }

    function setCookieSearch() {
        const search = searchInput.val();
        const selectClass = checksClass;
        setCookie("search", search);
        setCookie("class", selectClass);
    }

    async function updateSearch() {
        const searchContainer = $("#search-container");
        searchContainer.html('搜索中……');
        const Key = Keys[$("#key").val()];
        const Cmp = Cmps[$("#cmp").val()];
        const blogs = await loadSearch();
        const searchBlogs = [];
        // console.log("updateSearch", checksClass);
        for (const blog of blogs) {
            // console.log("look at", blog);
            if (checksClass.has(blog.class)) {
                blog.title = translateText(blog.title);
                searchBlogs.push(blog);
            }
        }
        searchBlogs.sort((a, b) => {
            // console.log(a, b, Key(a), Key(b), Cmp(Key(a), Key(b)), Key, Cmp);
            return Cmp(Key(a), Key(b));
        });
        searchContainer.empty(); // 清空现有内容
        blogFrame.attr("src", '');
        blogDec.empty();
        if (searchBlogs.length === 0) {
            searchContainer.html('<p>没有找到符合条件的文章</p>');
        } else {
            searchBlogs.forEach(blog => {
                const blogElement = $("<div>");
                blogElement.addClass("blog-item");
                blogElement.html(`
                    <a href="${blog.url}" target="_blank">
                        <h2>${blog.title}</h2>
                        <p>分类: ${blog.class}</p>
                        <p>日期: ${blog.date}</p>
                    </a>
                `);
                const a = blogElement.find("a");
                searchContainer.append(blogElement);
                blogElement.on("mouseenter", () => {
                    blogFrame.attr("src", blog.url);
                    blogDec.html(a.html());
                });
            });
            $(document).attr('title', `${searchInput.val()} - ${window.title}`);
        }
        execute();
        setCookieSearch();
        blogFrame.html('<p>悬停文章预览</p>');
    }

    function getClass(className) {
        return className.replace("/所有分类", "");
    }

    function checkCheckbox(checkbox, childStates) {
        checkbox.indeterminate = false;
        const children = $(checkbox).children().eq(2).find('input');
        const checked = $(checkbox).children().eq(0).prop("checked");
        if (checked) {
            checkbox.dataUOC = true;
        }
        children.each((index, child) => {
            const div = $(child).parent();
            div.dataUOC = false;
            if (checked) {
                childStates.set(div[0], $(child).prop("checked"));
                $(child).prop("checked", true);
            } else {
                if (!checkbox.dataUOC) {
                    childStates.set(div[0], false);
                }
                $(child).prop("checked", childStates.get(div[0]));
            }
            setCheckClass(div[0]);
        });
        if (!checked) {
            checkbox.dataUOC = false;
        }
        setCheckClass(checkbox);
    }

    function setCheckClass(checkbox) {
        const state = $(checkbox).children().eq(0).prop("checked");
        const className = getClass($(checkbox).children().eq(0).val());
        if (state) {
            checksClass.add(className);
        } else {
            checksClass.delete(className);
        }
    }

    function setCheckbox(checkbox) {
        setCheckClass(checkbox);
        const parent = $(checkbox).parent().parent().parent();
        if (parent.length && parent.attr("id") !== "search-class") {
            const parentCheckbox = parent.find("input");
            const checkState = Check(parent[0]);
            if (checkState === 1) {
                parentCheckbox.prop("checked", true);
                parentCheckbox.prop("indeterminate", false);
            } else if (checkState === 0) {
                parentCheckbox.prop("checked", false);
                parentCheckbox.prop("indeterminate", false);
            } else {
                parentCheckbox.prop("checked", false);
                parentCheckbox.prop("indeterminate", true);
            }
            setCheckbox(parent[0]);
        }
    }

    function Option(class_, base_class) {
        base_class += "/" + class_.name;
        let alloptions = $('<div>').get(0);
        let optionInput = $('<input>').prop({type: 'checkbox', checked: false, value: base_class, id: base_class}).get(0);
        $(alloptions).append(optionInput);
        let optionLabel = $('<label>').addClass("class-select").attr("for", base_class).text(class_.name).get(0);
        $(alloptions).append(optionLabel);
        const children = class_.children;
        let children_list = $('<ul>').get(0);
        for (let i in children) {
            const class_ = children[i];
            let children_option = $('<li>').get(0);
            $(children_option).append(Option(class_, base_class));
            $(children_list).append(children_option);
        }
        $(alloptions).append(children_list);
        // 保存子节点原始状态
        const childStates = new WeakMap();
        $(optionInput).on('click', e => {
            const parent = $(e.target).parent().get(0);
            checkCheckbox(parent, childStates);
            setCheckbox(parent);
            updateSearch();
        });
        return alloptions;
    }

    function getClasses() {
        return loadSearch().then(posts => {
            // 创建分类树结构
            const classTree = {name: "所有分类", children: []};

            posts.forEach(post => {
                const classPath = post.class.split('/').filter(Boolean);
                let currentLevel = classTree.children;

                classPath.forEach(className => {
                    let existingNode = currentLevel.find(node => node.name === className);
                    if (!existingNode) {
                        existingNode = {name: className, children: []};
                        currentLevel.push(existingNode);
                    }
                    currentLevel = existingNode.children;
                });
            });

            return classTree;
        });
    }
    // 修改InitSelect中的调用方式
    async function InitSelect() {
        const classes = await getClasses();
        const select = $("#search-class");
        select.empty();
        const ul = $('<ul>').get(0);
        select.append(ul);
        const li = $('<li>').get(0);
        const option = Option(classes, "");
        $(li).append(option);
        $(ul).append(li);
        getSelectClass();
        getSearch();
    }

    $(document).ready(InitSelect);
    InitSort();
    searchInput.on("keydown", e => {
        if (e.key === "Enter") {
            updateSearch();
        }
    });
</script>

</div>
<hr/>
<div id="footer-container">
    <footer>
        <a href="../license" target="_blank">版权申明</a>
        <br/>
        <a href="../robots.txt" target="_blank">机器人协议</a>
    </footer>
    <div style="height: 80px;"></div>
    <div id="text"></div>
<script>
    function translateText(text){
        const divText = $("#text");
        divText.html(text);
        translate.execute(divText.get(0));
        const res = divText.html();
        divText.html("");
        return res;
    }
</script>
    <script>
        execute();
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll("select").forEach((select) => {
                select.addEventListener('mouseenter', function () {
                    select.multiple = "multiple";
                })
                select.addEventListener('mouseleave', function () {
                    select.multiple = "";
                })
                select.addEventListener('change', function () {
                    select.multiple = "";
                })
            });
        })
    </script>
</div>
</body>
</html>